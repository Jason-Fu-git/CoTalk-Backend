{% extends "base.html" %}

{% block title %}Chat room{% endblock %}

{% block content %}
    <div id="chat">
    </div>
    <div id="chat-input">
        <input id="chat-message-input" type="text">
        <input id="chat-message-submit" type="submit" value="Send">
    </div>
{% endblock %}

{% block include_js %}
<script>
    document.addEventListener('DOMContentLoaded', (event) => {
        // DOM loaded
        const url='ws://'+window.location.host+
            '/ws/chat/room/';
        const chatSocket=new WebSocket(url);

        //客户端收到消息时触发
        chatSocket.onmessage=function(event) {
            const data=JSON.parse(event.data);
            const chat=document.getElementById('chat');

            //防止自己发给自己
            if (data.type)
            {
                console.log("Frontend receive: ");
                console.log(event);
                //将新消息添加到后面
                chat.innerHTML+='<div class="message">'+
                    data.message+'</div>';
                chat.scrollTop=chat.scrollHeight;
            }
        };

        chatSocket.onclose=function(event) {
            console.error('Chat socket closed unexpectedly');
        };

        const input=document.getElementById('chat-message-input');
        const submitButton=document.getElementById('chat-message-submit');

        submitButton.addEventListener('click', function(event) {
            const message=input.value;
            if (message)
            {
                console.log("Frontend send:");
                console.log(message);
                chatSocket.send(JSON.stringify({'message':message}));

                input.value='';
                input.focus();
            }
        });

        input.addEventListener('keypress', function(event) {
            if (event.key=='Enter')
            {
                //使用Enter也可以发送
                event.preventDefault();
                submitButton.click();
            }
        });

        input.focus();
    })
</script>
{% endblock %}